@page "/"

@rendermode InteractiveServer

<PageTitle>Home</PageTitle>

@code {
	private enum PlayerType {X, O}

	private bool gameStarted;
	private PlayerType? playerTypeSelection;
	private PlayerType?[] board = new PlayerType?[9];
	private PlayerType _currentPlayerType = PlayerType.X;
	private PlayerType? winner;
	private bool esEmpate;

	private string GameStatus
	{
		get
		{
			if (winner != null) return $"🏆 ¡Ganador: {winner}!";

			return esEmpate
				? "🤝 ¡Es un empate!"
				: $"Turno de: {_currentPlayerType}";
		}
	}

	private void SelectPlayerType(PlayerType playerType)
	{
		playerTypeSelection = playerType;
		StateHasChanged();
	}

	private void SelectPlayerX()
	{
		playerTypeSelection = PlayerType.X;
	}

	private void StartGame()
	{
		if (playerTypeSelection.HasValue)
		{
			gameStarted = true;
		}
	}

	private void HandleCellClick(int index)
	{
		// Ignorar si la celda esta ocupada o el juego termino.
		if (board[index] != null || winner != null || esEmpate)
		{
			return;
		}

		board[index] = _currentPlayerType;

		winner = CheckForWinner();
		if (winner != null)
		{
			return; // La partida finaliza.
		}

		// Comprobar empate.
		esEmpate = board.All(cell => cell != null);
		if (esEmpate)
		{
			return; // La partida termina.
		}

		// Cambiar turno.
		_currentPlayerType = (_currentPlayerType == PlayerType.X)
			? PlayerType.O
			: PlayerType.X;
	}

	private PlayerType? CheckForWinner()
	{
		var winningLines = new[]
		{
			new[] {0,1,2}, new[] {3,4,5}, new[] {6,7,8}, // Victorias Horizontales
			new[] {0,3,6}, new[] {1,4,7}, new[] {2,5,8}, // Victorias Verticales
			new[] {0,4,8}, new[] {2,4,6} // Victorias Diagonales
		};

		foreach (var line in winningLines)
		{
			var (a, b, c) = (line[0], line[1], line[2]);
			if (board[a].HasValue && board[a] == board[b] && board[a] == board[c])
			{
				return board[a];
			}
		}

		return null;
	}

	private void RestartGame()
	{
		gameStarted = false;
		playerTypeSelection = null;
		board = new PlayerType?[9];
		_currentPlayerType = PlayerType.X;
		winner = null;
		esEmpate = false;
	}

	private string GetPlayerClass(PlayerType? player)
	{
		if (!player.HasValue)
		{
			return "";
		}
		return player == PlayerType.X
			? "player-x"
			: "player-0";
	}
}
 