@page "/game"

@inject PlayerTypeService playerTypeService
@rendermode InteractiveServer

<PageTitle>Board TicTacToe</PageTitle>
<!-- Pantalla de Juego TicTacToe -->
<div class="game-screen">
	<h2 class="game-status">@GameStatus</h2>

	<div class="game-board">
		@for (var i = 0; i < 9; i++)
		{
			var cellIndex = i; // Copia local para evitar problemas con el closure desde el lamda

			<button class="cell @GetPlayerClass(playerTypeService.board[cellIndex])"
					@onclick="() => HandleCellClick(cellIndex)"
					disabled="@(playerTypeService.board[cellIndex] != null || playerTypeService.winner != null || playerTypeService.esEmpate)">
				@playerTypeService.board[cellIndex]?.ToString()
			</button>
		}
	</div>

	<button class="btn btn-secondary mt-4"
			@onclick="RestartGame"> Reiniciar Juego
	</button>
</div> 

@code {
	private string GameStatus
	{
		get
		{
			if (playerTypeService.winner != null) return $"🏆 ¡Ganador: {playerTypeService.winner}!";

			return playerTypeService.esEmpate
				? "🤝 ¡Es un empate!"
				: $"Turno de: {playerTypeService._currentPlayerType}";
		}
	}

	private void HandleCellClick(int index)
	{
		// Ignorar si la celda esta ocupada o el juego termino.
		if (playerTypeService.board[index] != null || playerTypeService.winner != null || playerTypeService.esEmpate)
		{
			return;
		}

		playerTypeService.board[index] = playerTypeService._currentPlayerType;

		playerTypeService.winner = CheckForWinner();
		if (playerTypeService.winner != null)
		{
			return; // La partida finaliza.
		}

		// Comprobar empate.
		playerTypeService.esEmpate = playerTypeService.board.All(cell => cell != null);
		if (playerTypeService.esEmpate)
		{
			return; // La partida termina.
		}

		// Cambiar turno.
		playerTypeService._currentPlayerType = (playerTypeService._currentPlayerType == PlayerType.X)
			? PlayerType.O
			: PlayerType.X;
	}

	private PlayerType? CheckForWinner()
	{
		var winningLines = new[]
		{
			new[] {0,1,2}, new[] {3,4,5}, new[] {6,7,8}, // Victorias Horizontales
			new[] {0,3,6}, new[] {1,4,7}, new[] {2,5,8}, // Victorias Verticales
			new[] {0,4,8}, new[] {2,4,6} // Victorias Diagonales
		};

		foreach (var line in winningLines)
		{
			var (a, b, c) = (line[0], line[1], line[2]);
			if (playerTypeService.board[a].HasValue && playerTypeService.board[a] == playerTypeService.board[b] && playerTypeService.board[a] == playerTypeService.board[c])
			{
				return playerTypeService.board[a];
			}
		}

		return null;
	}

	private void RestartGame()
	{
		playerTypeService.Reset();
	}

	private string GetPlayerClass(PlayerType? player)
	{
		if (!player.HasValue)
		{
			return "";
		}
		return player == PlayerType.X
			? "player-x"
			: "player-o";
	}
}
